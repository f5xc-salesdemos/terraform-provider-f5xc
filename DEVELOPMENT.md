# Development Guide

Community-driven Terraform provider for F5 Distributed Cloud (F5XC)
built using the HashiCorp Terraform Plugin Framework. The provider
implements F5's public OpenAPI specifications to manage F5XC resources
via Terraform.

## Build & Development Commands

```bash
# Build the provider binary
go build -o terraform-provider-f5xc

# Run all tests
go test ./...

# Run acceptance tests (requires F5XC_API_TOKEN or F5XC_P12_FILE)
TF_ACC=1 go test ./... -v -timeout 120m

# Generate documentation (requires terraform CLI)
go generate ./...

# Install locally for testing
mkdir -p ~/.terraform.d/plugins/registry.terraform.io/f5xc-salesdemos/f5xc/0.1.0/darwin_arm64
cp terraform-provider-f5xc ~/.terraform.d/plugins/registry.terraform.io/f5xc-salesdemos/f5xc/0.1.0/darwin_arm64/
```

## Environment Variables

- `F5XC_API_TOKEN` - API token for F5 Distributed Cloud (one of token or P12 required)
- `F5XC_API_URL` - Optional API URL (defaults to `https://console.ves.volterra.io`)
- `F5XC_P12_FILE` - Path to P12 certificate file (alternative to token auth)
- `F5XC_P12_PASSWORD` - Password for P12 file (required with F5XC_P12_FILE)
- `TF_ACC=1` - Enable acceptance tests

## Architecture

### Directory Structure

- `main.go` - Provider entry point with version injection via goreleaser
- `internal/provider/` - All Terraform resources and data sources
- `internal/client/` - F5XC API client (HTTP client with CRUD operations and type definitions)
- `internal/functions/` - Provider-defined functions (manually maintained)
- `internal/blindfold/` - F5XC Secret Management encryption library (manually maintained)
- `tools/` - Code generation utilities for scaffolding new resources from OpenAPI specs
- `docs/` - Auto-generated provider documentation for Terraform Registry
- `examples/` - Example Terraform configurations
- `templates/` - Templates for doc generation (`tfplugindocs`)

### Resource Implementation Pattern

Each resource follows the Terraform Plugin Framework pattern:

1. **Resource struct** implementing `resource.Resource`, `resource.ResourceWithConfigure`, `resource.ResourceWithImportState`
2. **Model struct** with `tfsdk` tags for state management
3. **CRUD methods**: `Create`, `Read`, `Update`, `Delete`
4. **Registration** in `provider.go` via `Resources()` function

Example reference: `internal/provider/namespace_resource.go`

### Client Architecture

`internal/client/client.go` contains:

- HTTP client wrapper for F5XC API (`Client` struct)
- Type definitions for all F5XC resources
- CRUD methods following pattern: `Create{Resource}`, `Get{Resource}`, `Update{Resource}`, `Delete{Resource}`

API authentication uses Bearer token: `Authorization: APIToken {token}`

### Code Generation

The `tools/` directory contains generators for scaffolding resources from F5 OpenAPI specs:

- `generate-all-schemas.go` - Main generator for provider resources, data sources, and client types from v2 domain specs
- `transform-docs.go` - Transforms generated documentation with enhanced metadata
- `generate-examples.go` - Generates Terraform example configurations

## Generated Files (Never Commit Manually)

| Directory/File | Generated By | Workflow |
| --- | --- | --- |
| `docs/resources/*.md` | `tfplugindocs` + `transform-docs.go` | `on-merge.yml` |
| `docs/data-sources/*.md` | `tfplugindocs` + `transform-docs.go` | `on-merge.yml` |
| `docs/functions/*.md` | `tfplugindocs` | `on-merge.yml` |
| `docs/guides/*.md` | `tfplugindocs` (from `templates/guides/`) | `on-merge.yml` |
| `examples/resources/*/*.tf` | `generate-examples.go` | `on-merge.yml` |
| `examples/data-sources/*/*.tf` | `generate-examples.go` | `on-merge.yml` |
| `internal/provider/*_resource.go` | `generate-all-schemas.go` | `on-merge.yml` |
| `internal/provider/*_data_source.go` | `generate-all-schemas.go` | `on-merge.yml` |

To fix a bug in generated code, fix the **generator** not the generated file. CI blocks PRs containing manually-modified generated files.

## Manually Maintained Files

These files live in otherwise auto-generated directories but are hand-written:

| File | Purpose |
| --- | --- |
| `internal/provider/functions_registration.go` | Registers provider-defined functions |
| `internal/provider/addon_service_data_source.go` | Data source for addon service details |
| `internal/provider/addon_service_activation_status_data_source.go` | Data source for addon activation |
| `templates/functions.md.tmpl` | Template for function documentation |
| `templates/guides/*.md` | Guide source files |
| `examples/functions/*/function.tf` | Function example configurations |
| `examples/guides/*/` | Guide example Terraform modules |

## Workflow Architecture

```
Push to main (human commit)
         |
         v
+------------------+
| Detect Changes   | <-- What changed? (specs/code/tools)
+--------+---------+
         |
         v
+------------------+
| Build & Test     | <-- Validate merged code
+--------+---------+
         |
    +----+----+
    v         v
+-------+ +-------+
| Regen | | Regen | <-- Regenerate if needed
|Provider| | Docs  |
+---+---+ +---+---+
    +----+----+
         v
+------------------+
| Create PR        | <-- Single consolidated PR
| (if changes)     |   for all regeneration
+--------+---------+
         |
         v
+------------------+
| Tag & Release    | <-- ONE version bump
+------------------+
```

Reusable workflows (`_build-test.yml`, `_generate-docs.yml`, `_generate-provider.yml`, `_tag-release.yml`) are called by the `on-merge.yml` orchestrator.

## Provider-Defined Functions

### The `blindfold` Function

Encrypts base64-encoded plaintext using F5XC blindfold encryption:

```hcl
provider::f5xc::blindfold(plaintext, policy_name, namespace)
```

### The `blindfold_file` Function

Reads a file and encrypts its contents:

```hcl
provider::f5xc::blindfold_file(path, policy_name, namespace)
```

Requirements: Terraform 1.8.0+, valid F5XC provider config, existing SecretPolicy.

### Adding New Functions

1. Create implementation in `internal/functions/`
2. Register in `internal/provider/functions_registration.go`
3. Create examples in `examples/functions/<name>/function.tf`
4. Add unit tests
5. Update preservation lists in `tools/generate-all-schemas.go`

## Guides

Guide source files live in `templates/guides/`. Examples in `examples/guides/`. CI copies guides to `docs/guides/` via `tfplugindocs` on merge.

All guides need YAML frontmatter:

```yaml
---
page_title: "Guide: Title Here"
subcategory: "Guides"
description: |-
  Brief description.
---
```

## F5XC API v2 Specs

Starting with v3.0.0, the provider uses v2 API specs from the enriched API repository. Resources are organized into domain categories (Security, Networking, Infrastructure, Platform, Operations, AI). The generator auto-detects spec version and processes domain files containing multiple resources each.

## Release Process

Releases are automated via GoReleaser on tag push (`v*`):
1. Builds cross-platform binaries
2. Signs checksums with GPG
3. Publishes to GitHub Releases with Terraform Registry manifest

## Key Dependencies

- `github.com/hashicorp/terraform-plugin-framework` - Core Terraform provider SDK
- `github.com/hashicorp/terraform-plugin-log` - Structured logging
